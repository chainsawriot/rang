## generated by gran, do not edit by hand

.install_packages <- function(tarball_path, lib, verbose, current_r_version) {
    if (utils::compareVersion(current_r_version, "3.0") != -1) {
        if (is.na(lib)) {
            install.packages(pkg = tarball_path, repos = NULL, verbose = verbose, quiet = !verbose)
        } else {
            install.packages(pkg = tarball_path, lib = lib, repos = NULL, verbose = verbose, quiet = !verbose)
        }
    } else {
        if (is.na(lib)) {
            install.packages(pkg = tarball_path, repos = NULL)
        } else {
            install.packages(pkg = tarball_path, lib = lib, repos = NULL)
        }
    }
}

.download_package <- function(tarball_path, x, verbose) {
    url <- paste(cran_mirror, "src/contrib/Archive/", names(x), "/", names(x), "_", x, ".tar.gz", sep = "")
    tryCatch({
        suppressWarnings(download.file(url, destfile = tarball_path, quiet = !verbose))
    }, error = function(e) {
        ## is the current latest
        url <- paste(cran_mirror, "src/contrib/", names(x), "_", x, ".tar.gz", sep = "")
        download.file(url, destfile = tarball_path, quiet = !verbose)
    })
    invisible(tarball_path)
}

.install_from_cran <- function(x, lib, path = tempdir(), verbose, cran_mirror, current_r_version) {
    tarball_path <- file.path(path, paste(names(x), "_", x, ".tar.gz", sep = ""))
    if (!file.exists(tarball_path)) {
        .download_package(tarball_path = tarball_path, x = x, verbose = verbose)
    }
    .install_packages(tarball_path, lib, verbose, current_r_version)
    ## check and error
    if (!is.na(lib)) {
        installed_packages <- installed.packages(lib.loc = lib)
    } else {
        installed_packages <- installed.packages()
    }
    if (!names(x) %in% dimnames(installed_packages)[[1]]) {
        stop("Fail to install ", names(x), "\n")
    }
    invisible()
}

# installing github packages
.download_github_safe <- function(pkg,sha,file){
  tryCatch(
    download.file(paste("http://api.github.com/repos/", pkg, "/tarball/", sha, sep = ""), destfile = file),
    error = function(e){
      stop(paste0("couldn't download ",pkg," from github"),call. = FALSE)
    }
  )
}

.install_from_github <- function(x, lib){
  pkg <- names(x)
  sha <- unname(x)
  dest_tar <- tempfile(fileext = ".tar.gz")
  tmp_dir <- tempdir(check = TRUE)
  tryCatch(
    download.file(paste("https://api.github.com/repos/", pkg, "/tarball/", sha, sep = ""), destfile = dest_tar),
    error = function(e){
      .download_github_safe(pkg,sha,dest_tar)
    }
  )
  
  system(command = paste("tar", "-zxf ", dest_tar, "-C", tmp_dir))
  dlist <- list.dirs(path = tmp_dir, recursive = FALSE)
  pkg_dir <- dlist[grepl(sha, dlist)]
  if(length(pkg_dir)!=1){
    stop(paste0("couldn't locate the unzipped package source in ",tmp_dir))
  }
  
  res <- system(command = paste("cd ", tmp_dir, " && R", "CMD", "build", pkg_dir), intern = TRUE)
  tar_file_line <- res[grepl("*.tar.gz", res)]
  flist <- list.files(tmp_dir, pattern = "tar.gz", recursive = FALSE)
  tarball_path <- paste0(tmp_dir, "/", flist[vapply(flist, function(f) any(grepl(f, res)), logical(1))])
  if(length(tarball_path)!=1){
    stop(paste0("couldn't locate the install tarball in ",tmp_dir))
  }
  install.packages(tarball_path, repos = NULL,lib = lib)
  unlink(tarball_path)
}
